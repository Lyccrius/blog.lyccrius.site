---
layout: post
title:  SXA3 第 3 周模拟赛讲评
date:   2023-01-01
author: noip
categories: course luogu-class yugu22sx1a
---

# A 虚空处刑

## 题目描述

给定一个长为 $n$ 的序列 $a$，每个位置是一个 $[1,n]$ 内的整数。

定义 $f(i,j)$ 表示有多少 $x$ 满足 $i\le x<j$ 且 $a_x\neq a_{x+1}$。

有 $m$ 次操作：

`1 l r x`：表示将区间 $[l,r]$ 中所有元素都修改为 $x$。

`2 l r x`：表示查询区间 $[l,r]$ 中，对任意 $l\le i<j\le r$，且 $a_i=a_j=x$，$f(i,j)$ 的和。

## 输入格式

第一行两个数 $n,m$。

第二行 $n$ 个用空格隔开的数表示序列 $a$。

之后 $m$ 行，每行四个用空格隔开的数 $opt,l,r,x$ 表示一次操作。

## 输出格式

对每个 $2$ 操作，输出一行一个数表示答案。

## 样例 #1

### 样例输入 #1

```
10 10
2 1 2 1 8 3 2 1 2 2
2 6 9 2
2 3 10 2
2 2 10 2
2 1 3 2
2 4 10 1
1 2 4 2
2 3 10 2
2 2 7 1
2 2 7 2
2 3 6 2
```

### 样例输出 #1

```
2
20
20
2
4
30
0
9
0
```

## 提示

对于 $20\%$ 的数据，满足 $1\le n,m\le 1000$。

对于另外 $20\%$ 的数据，没有 $1$ 操作。

对于另外 $10\%$ 的数据，数据中的操作类型在 $[1,2]$ 内， $a_i,x$ 在 $[1,100]$ 内均匀随机生成，区间 $[l,r]$ 两个端点为 $[1,n]$ 中均匀随机生成的整数，如果生成后 $l>r$，则将二者交换。

对于另外 $20\%$ 的数据，满足 $1\le n,m\le 10^5$。

对于 $100\%$ 的数据，满足 $1\le n,m \le 5\times10^5$，$1\le l\le r\le n$，$1\le a_i,x\le n$，所有输入均为整数。

## 题解

对序列按 $\Theta (\sqrt n)$ 大小分块。

这个信息是分治信息。

对每个块分类讨论：
1.  这个块只有一种颜色。
2.  这个块内有多种颜色。

对于 $2$ 情况，维护这个块内对每个颜色的分治信息。每次进行范围 $[l, r]$ 染色为 $c$ 的操作时，会把一些完整的块变成颜色为 $c$ 的，以及把 $\mathcal O(1)$ 个块内部进行一次区间染色为 $c$ 的操作。

同色块的颜色从 $b$ 变为 $c$ 只需要 $\mathcal O(1)$ 的时间处理，块内部区间染色可以使用颜色段均摊，等价于进行了 $\mathcal O(n + m)$ 次颜色段的修改，每次修改可以 $\mathcal O(\sqrt n)$ 代价重构零散块。

每次查询 $[l, r]$ 时，在左右两端的块内查询出该颜色的分治信息，然后在中间的块内，若一个块只有一种颜色，则可以 $\mathcal O(1)$ 计算出其分治信息，否则直接取该颜色对应的块内分治信息。

之后按顺序合并分治信息即可。

总时间复杂度 $\mathcal O((n + m) \sqrt n)$。

# B 超人机械

## 题目描述

给包含 $n$ 个顶点的有根树，每个顶点 $i$ 在时刻 $t$ 有权重 $v(t,i)$。

对每个顶点给出 $v(0,i)$，保证对非叶节点 $i$ 有 $v(0,i)=0$，对叶子 $i$ 有 $0\le v(0,i)\le n$。

共 $m$ 次询问，每次询问给出 $x,y,t$，问 $x$ 到 $y$ 路径上在时刻 $t$ 的权重的最小值、最大值、和。

对叶子 $i$，有 $v(t,i)=v(0,i)$；

对非叶节点 $i$，$t>0$，$v(t,i)$ 是 $i$ 的每个孩子 $j$ 的 $v(t-1,j)$ 的最大值。

## 输入格式

第一行两个整数 $n,m$。

接下来 $n-1$ 行每行一个整数依次表示 $f_2,\dots,f_n$，其中 $f_i$ 表示节点 $i$ 的父亲，根为 $1$。

接下来 $n$ 行每行一个整数依次表示 $v(0,1),v(0,2),\dots,v(0,n)$。

接下来 $m$ 行，每行三个整数表示 $x,y,t$。

## 输出格式

输出 $m$ 行，共 $m$ 个整数表示每个询问的答案。

## 样例 #1

### 样例输入 #1

```
8 3
1
2
3
3
3
4
4
0
0
0
0
7
5
7
5
7 5 8
1 2 8
8 2 8
```

### 样例输出 #1

```
7 7 28
7 7 14
5 7 26
```

## 提示

对于 $100\%$ 的数据，满足  $1\le n,m\le 2\times 10^5$，$1\le f_i\le i-1$，$0\le v(0,i)\le n$，$1\le x,y,t\le n$。

对于 $25\%$ 的数据，满足 $n,m\le 10^3$。

对于另外 $25\%$ 的数据，满足 $f_i=i-1$。

对于另外 $25\%$ 的数据，满足 $f_i=\lfloor\frac i2\rfloor$。

对于另外 $25\%$ 的数据，无特殊限制。

## 题解

由于只有叶子的 $v$ 初始非零，且叶子的 $v$ 不变，容易证明所有点的 $v$ 是单调不减的，于是每个点每一时刻的 $v$ 是上一时刻的 $v$ 对孩子上一时刻的 $v$ 取 $\max$。

对树进行轻重链剖分，转化为维护序列，初值全零，支持单点增大（轻子树对重链的影响），每一时刻序列每个位置 $x$ 边为上一时刻位置 $x, x + 1$ 的最大值（重链上的情况），查询区间最小值、最大值、和。可以用平衡树维护相邻相同的值构成的段，均摊地删去长度变为 $0$ 的段。

时间复杂度 $\mathcal O((n + m) \log^2 n)$。

# C. 堕天作战【省选计划 · 模拟赛 #3】

## 题目描述

给定 $n$ 个点 $(x_i,y_i)_{i=1}^n$，你需要按顺序处理 $m$ 次操作。每次操作给出 $o,x,y,X,Y$，

- 首先进行修改：
  - 若 $o=1$ 则将满足 $x_i\le x,\;y_i\le y$ 的点的 $y_i$ 修改为 $y$；
  - 若 $o=2$ 则将满足 $x_i\le x,\;y_i\le y$ 的点的 $x_i$ 修改为 $x$。
- 然后进行查询，询问满足 $x_i\le X,\;y_i\le Y$ 的点数。

## 输入格式

第一行两个整数 $n,m$。

接下来 $n$ 行每行两个整数 $x_i,y_i$。

接下来 $m$ 行每行五个整数 $o,x,y,X,Y$，表示一次操作。

## 输出格式

共 $m$ 行，每行一个整数，依次表示每次操作进行的查询的答案。

## 样例 #1

### 样例输入 #1

```
5 6
1 2
3 1
5 1
3 5
4 4
1 4 2 5 4
1 4 3 5 3
2 3 5 1 3
2 2 3 1 4
1 3 3 1 4
2 5 5 2 1
```

### 样例输出 #1

```
4
3
0
0
0
0
```

## 提示

对于所有数据，$1 \le n,m \le 10^6$，$1\le x_i,y_i,x,y,X,Y\le n$。

子任务 1（20 分）：$n,m\le 10^3$；

子任务 2（20 分）：$x_i,y_i,x,y,X,Y$ 独立地在 $1$ 到 $n$ 内均匀随机选取；

子任务 3（20 分）：$o=1$；

子任务 4（20 分）：$n,m\le 3\times 10^5$，依赖子任务 1；

子任务 5（20 分）：无特殊限制，依赖子任务 1、2、3、4。

## 题解

将点集分为未移动的部分和移动过的部分维护，移动过的点按最后一次移动的 $opt$ 分类维护。

对于最后一次移动的 $opt = 1$（$opt = 2$）的点维护 $x$（$y$）的前缀点数。

定义分界线为已进行的修改操作的 $(x, y)$ 的左下方区域的并的边界。

移动过的点都在分界线上，未移动过的点都在分界线上或右上方。

分界线可以用若干段水平或竖直的线段表示，每次修改操作造成均摊 $\mathcal O(1)$ 次线段插入删除，需要找出这次操作中首次发生移动的点，并维护发生变化的线段上的点。

以 $opt = 1$ 为例，需要删除若干竖直线段，合并多条水平线段，找出这次操作中首次发生移动的点。

查询 $(X, Y)$ 左下方的点数，如果 $(X, Y)$ 在分界线的左下方，则答案为 $0$，否则可以差分查询 $(X, Y)$ 上方、右方、右上方的点数，右上方的点数都没有移动过，可以在初始给的点集上查询矩形和，上方和右方可以在动态维护的未移动/移动过的点中查询前缀和。

时间复杂度 $\mathcal O((n + m) \log n)$。